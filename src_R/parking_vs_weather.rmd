---
title: "Do weather affect driving patterns?"
author: "Sindre SÃ¸nvisen"
date: "10/18/2020"
output: 
  html_document:
    df_print: paged
---

```{css, comment=NA, message=FALSE, echo=FALSE, warning=FALSE}
body {background-color: lightgray;}
```

```{r setup, include=FALSE, comment=NA, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("wrangle_new.r")
source("regression.r")
library(leaflet) #Map
```

# Introduction:
<pre>
  This project is about testing whether the weather has a say in the  
  number of available parking spaces in Stavanger.
</pre>

# Data:
<pre>
  The weather data is collected from:
    Norwegian klima service senter:
      https://klimaservicesenter.no/observations/
    Temperature and Precipitation from station id:SN44640.
    Wind information from station id:SN44560. (consider changing...)
  The parking data is collected from:
    https://open.stavanger.kommune.no/dataset/stavanger-parkering/
    
  More information on each parking lot:
    https://stavanger-parkering.no/parkering/p-hus/
</pre>

# Hypothesis:
<pre>
  The available parking spaces goes down in bad weather.
</pre>

## Map
```{r map, comment=NA, message=FALSE, echo=FALSE, warning=FALSE}
map3 <- leaflet() %>%
addTiles() #%>%  # Add default OpenStreetMap map tiles
for(n in 1:n_places){
  temp <- loc_parking[n,]
  map3 <- map3 %>% addMarkers(lat=temp$Lat, lng=temp$Lon, popup=temp$Place)
}
map3
```

## Correlation
A schema of correlation between the parking lots and the different weather aspects. We use data every day between 08:00 and 18:00.

```{r Correlation, comment=NA, message=FALSE, echo=FALSE, warning=FALSE}
df_temp <- df_main %>% 
  filter(hour(DateTime) >= 8) %>%
  filter(hour(DateTime) <= 18) %>% 
  .[-c(1)]
grid.table(
  abs(
    round(
      cor(
      x=df_temp[,1:9], 
      y=df_temp[,c("Air_temp degC", "Precipitation mm", "wind_speed m/s")], 
      use = "complete.obs", 
      method = c("pearson")
      ), 
      2)
  )
)
```

This does not paint a clear picture of a correlation. But if we say values over 0.3 is a week correlation we have at least one number above that (Siddis and Air temperature). To inspect further we do linear regression on the data.

## Linear regression
Three interactive regression plots for respectively Air temprure, Precipitation and wind speed. Siddis is set as standard for the regression graphs because it shows the most promising values in the correlation table, but feel free to change and inspect the other parking lots as well. Note. Forum and Parketten have some problems/anomalies in its data (see time graphs bellow)

```{r Regression, comment=NA, message=FALSE, echo=FALSE, warning=FALSE}
# make_regression(data, value) is a function made specific for this data set, and is not intended as a genera function.
df_temp2 <- df_main %>% filter(hour(DateTime) >= 8) %>%
  filter(hour(DateTime) <= 18)
df_temp2 %>% make_regression(., "Air_temp degC")
df_temp2 %>% make_regression(., "Precipitation mm")
df_temp2 %>%  make_regression(., "wind_speed m/s")
```

As we can see the data for the air temperature do seam to go the oppose direction from what I expected. The available parking seam to go down in higher temperature (exept for Forum). For Precipitation and wind speed thay do not seam to follow tha same trend and som of them goes up and some goes down in higer/lower Precipitation and wind speed. This can chnage as time goes on and we collect more data. The weather unfortunately for this project seam to have bean fairly stable. To inspect even deeper a time plot for both the parking data and weather is plotted bellow.

## Time graphs
```{r Time_p, comment=NA, message=FALSE, echo=FALSE, warning=FALSE}
df_parking %>% ungroup() %>%
  plot_ly(x = ~DateTime, y = ~Free_spaces, color = ~Place, mode = "lines") %>%
  layout(
    title = list(text = "Parking time graph", x = 0.1),
    yaxis = list(title = "Available parking spaces"),
    xaxis = list(Titel = "Date",
                 rangeselector = list(x = 0.01, y = 0.97,
                   buttons = list(
                     list(
                       count = 1,
                       label = "1 day",
                       step = "day",
                       stepmode = "backward"),
                     list(
                       count = 7,
                       label = "1 week",
                       step = "day",
                       stepmode = "backward"),
                     list(
                       count = 1,
                       label = "1 month",
                       step = "month",
                       stepmode = "backward"),
                     list(
                       count = 1,
                       label = "YTD",
                       step = "year",
                       stepmode = "todate"),
                     list(step = "all"))),
                 rangeslider = list(type = "date"))
    )

```

```{r Time_W, comment=NA, message=FALSE, echo=FALSE, warning=FALSE}
df_weather %>% filter(Element != "wind_direction degrees") %>% ungroup() %>%
  plot_ly(x = ~DateTime, y = ~Value, color = ~Element, mode = "lines") %>%
  layout(
    title = list(text = "weather time graph", x = 0.1),
    yaxis = list(title = "Value"),
    xaxis = list(Titel = "Date",
                 rangeselector = list(x = 0.01, y = 0.97, 
                   buttons = list(
                     list(
                       count = 1,
                       label = "1 day",
                       step = "day",
                       stepmode = "backward"),
                     list(
                       count = 7,
                       label = "1 week",
                       step = "day",
                       stepmode = "backward"),
                     list(
                       count = 1,
                       label = "1 month",
                       step = "month",
                       stepmode = "backward"),
                     list(
                       count = 1,
                       label = "YTD",
                       step = "year",
                       stepmode = "todate"),
                     list(step = "all"))),
                 rangeslider = list(type = "date"))
    )

```

# Methods used:
## Collecting data
I chose to use python 3 for the data collection because i was most familiar with it at the time when i started this project. Python is also a good language to use in this scenario since we are collecting from the web and errors can occur. The exception clause in python make it easy to collect these errors and make sure we do not have a crash if/when a unexpected error occurs.

### Python code:
#### sceduler:
I made my own scheduler instead of using soothing lake cron in linux. This was manly because i was personally interested and i culd easely used cron job instead since it runs on a linux server, The only advantage is that no alteration is required to run in an other os.

#### Web scrapers:

## Data wrangling using r

## Data presentation r-markdown/plotly